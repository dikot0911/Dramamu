<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Referral & Penarikan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="premium-styles.css">
    <script src="premium-icons.js"></script>
    <script src="premium-init.js"></script>
    <style>
        .card {
            background: rgba(30, 41, 59, 0.85);
            border: 1.5px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.25);
        }
        
        #referral-link {
            background: rgba(15, 23, 42, 0.8);
            border: 1.5px solid rgba(212, 175, 55, 0.3);
            color: #f1f5f9;
            font-size: 14px;
            font-weight: 500;
        }
        
        #referral-link::placeholder {
            color: rgba(148, 163, 184, 0.5);
        }
        
        input, select {
            background: rgba(15, 23, 42, 0.6);
            border: 1.5px solid rgba(148, 163, 184, 0.3);
            color: #f1f5f9;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
    </style>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="w-full h-screen overflow-hidden relative flex flex-col" style="position: relative; z-index: 1;">
        
        <header class="premium-header w-full z-20">
            <h1>Referral & Penarikan</h1>
        </header>
        
        <main class="flex-1 overflow-y-auto scrollbar-hide p-4 pb-24">
            <div class="max-w-md mx-auto space-y-6">
        
        <div class="card p-5 rounded-lg">
            <h2 class="text-lg font-bold text-white mb-4">üìä Statistik</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900/40 p-3 rounded-lg border border-slate-700/50">
                    <p class="text-sm text-gray-400 mb-1">Total Referral</p>
                    <p id="total-referrals" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="bg-slate-900/40 p-3 rounded-lg border border-slate-700/50">
                    <p class="text-sm text-gray-400 mb-1">Total Komisi</p>
                    <p id="total-komisi" class="text-xl font-bold" style="color: #d4af37;">Rp 0</p>
                </div>
            </div>
        </div>

        <div class="card p-5 rounded-lg">
            <h2 class="text-lg font-bold text-white mb-2">üîó Link Referral Anda</h2>
            <p class="text-sm text-gray-400 mb-4">Bagikan link ini & dapatkan komisi setiap kali teman membeli VIP:</p>
            <div class="relative mb-2">
                <input type="text" id="referral-link" readonly class="w-full p-3 rounded-lg pr-12" placeholder="Loading link referral...">
                <button onclick="copyLink()" class="absolute right-3 top-1/2 -translate-y-1/2 text-2xl hover:scale-110 transition-transform" style="filter: grayscale(0.3);">
                    üìã
                </button>
            </div>
            <p class="text-xs text-gray-500">Komisi: 25% dari setiap pembelian VIP</p>
        </div>
        
        <div class="card p-5 rounded-lg">
            <h2 class="text-lg font-bold text-white mb-2">üí∞ Penarikan Komisi</h2>
            <div class="bg-slate-900/40 p-3 rounded-lg border border-slate-700/50 mb-4">
                <p class="text-sm text-gray-400 mb-1">Min. Penarikan: <b class="text-white">Rp 50.000</b></p>
                <p class="text-sm text-gray-400">Saldo Anda: <b id="sisa-saldo" style="color: #d4af37;">Rp 0</b></p>
            </div>

            <form id="withdraw-form" class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-white block mb-2">Jumlah Penarikan (Rp)</label>
                    <input type="number" id="jumlah" required class="w-full p-3 rounded-lg" placeholder="Min. Rp 50.000">
                </div>
                <div>
                    <label class="text-sm font-medium text-white block mb-2">Metode Pembayaran</label>
                    <select id="metode" required class="w-full p-3 rounded-lg">
                        <option value="">Pilih metode...</option>
                        <option value="BCA">BCA</option>
                        <option value="BRI">BRI</option>
                        <option value="BNI">BNI</option>
                        <option value="Mandiri">Mandiri</option>
                        <option value="DANA">DANA</option>
                        <option value="OVO">OVO</option>
                        <option value="GoPay">GoPay</option>
                        <option value="ShopeePay">ShopeePay</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium text-white block mb-2">Nomor Rekening / E-Wallet</label>
                    <input type="text" id="nomor_rekening" required class="w-full p-3 rounded-lg" placeholder="Contoh: 1234567890">
                </div>
                <div>
                    <label class="text-sm font-medium text-white block mb-2">Nama Pemilik</label>
                    <input type="text" id="nama_pemilik" required class="w-full p-3 rounded-lg" placeholder="Nama sesuai rekening">
                </div>
                <button type="submit" class="w-full font-bold py-3 rounded-lg" style="background: linear-gradient(135deg, #d4af37 0%, #f0d266 100%); color: #0f0f1e; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 30px rgba(212, 175, 55, 0.6)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 6px 20px rgba(212, 175, 55, 0.4)';">
                    Ajukan Penarikan
                </button>
            </form>
        </div>
            </div>
        </main>
    </div>
    
    <script src="navbar.js?v=222222222"></script>
    <script src="notification.js"></script>

    <script>
        // Cached DOM elements (performance optimization)
        let cachedElements = {};
        
        function getCachedElement(id) {
            if (!cachedElements[id]) {
                cachedElements[id] = document.getElementById(id);
            }
            return cachedElements[id];
        }
        
        const tg = window.Telegram?.WebApp;
        let bot_username = "dramamu_bot";
        
        // Initialize Telegram WebApp if available
        if (tg) {
            tg.ready();
            tg.enableClosingConfirmation();
            tg.disableVerticalSwipes();
            console.log("üîí Vertical swipes disabled - mini app tidak akan close saat scroll");
        } else {
            console.warn('‚ö†Ô∏è Telegram WebApp not available');
        }

        const user = tg?.initDataUnsafe?.user;

        async function loadConfig() {
            try {
                const response = await fetch(window.API_BASE_URL + '/api/v1/config');
                const config = await response.json();
                bot_username = config.bot_username || 'dramamu_bot';
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            fetchReferralStats();
        });

        async function fetchReferralStats() {
            try {
                if (!tg || !tg.initData) {
                    console.error('‚ùå Cannot get Telegram initData!');
                    notification.error('‚ùå Telegram data tidak tersedia', 'error', {
                        duration: 3000,
                        sound: false
                    });
                    return;
                }

                console.log('üìä Fetching referral stats...');
                const response = await fetch(window.API_BASE_URL + '/api/v1/referral_stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        init_data: tg.initData
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('‚ùå Unauthorized - Invalid Telegram data');
                        notification.error('‚ùå Session tidak valid. Silakan tutup dan buka kembali aplikasi.', 'error', {
                            duration: 5000,
                            sound: false
                        });
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return;
                }
                
                const stats = await response.json();
                
                console.log('‚úÖ Referral stats loaded:', stats);
                
                // Update UI dengan data dari server
                getCachedElement('total-referrals').textContent = stats.total_referrals || 0;
                getCachedElement('total-komisi').textContent = `Rp ${(stats.commission_balance || 0).toLocaleString('id-ID')}`;
                getCachedElement('sisa-saldo').textContent = `Rp ${(stats.commission_balance || 0).toLocaleString('id-ID')}`;
                
                // CRITICAL: Set referral link dengan ref_code dari server
                const refLink = `https://t.me/${bot_username}?start=${stats.ref_code}`;
                console.log('üîó Referral link generated:', refLink);
                getCachedElement('referral-link').value = refLink;
                
                console.log('‚úÖ Referral stats rendered successfully');
                
            } catch (error) {
                console.error("‚ùå Error fetching referral stats:", error);
                notification.error(`‚ùå Gagal memuat data referral: ${error.message}`, 'error', {
                    duration: 4000,
                    sound: false
                });
            }
        }

        getCachedElement('withdraw-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!tg || !tg.initData) {
                notification.error('‚ùå Telegram data tidak tersedia. Silakan tutup dan buka kembali aplikasi.', 'error', {
                    duration: 3000,
                    sound: false
                });
                return;
            }
            
            const jumlahInput = getCachedElement('jumlah').value.trim();
            const metode = getCachedElement('metode').value;
            const nomor_rekening = getCachedElement('nomor_rekening').value.trim();
            const nama_pemilik = getCachedElement('nama_pemilik').value.trim();
            
            // Validasi input
            if (!jumlahInput) {
                notification.error('‚ùå Masukkan jumlah yang ingin ditarik', 'error', {
                    duration: 2000,
                    sound: false
                });
                return;
            }
            
            const jumlah = parseInt(jumlahInput);
            
            if (isNaN(jumlah) || jumlah <= 0) {
                notification.error('‚ùå Jumlah harus berupa angka positif', 'error', {
                    duration: 2000,
                    sound: false
                });
                return;
            }
            
            if (jumlah < 50000) {
                notification.error('‚ùå Minimum penarikan adalah Rp 50.000', 'error', {
                    duration: 2000,
                    sound: false
                });
                return;
            }
            
            if (!nomor_rekening) {
                notification.error('‚ùå Masukkan nomor rekening / e-wallet', 'error', {
                    duration: 2000,
                    sound: false
                });
                return;
            }
            
            if (!nama_pemilik) {
                notification.error('‚ùå Masukkan nama pemilik rekening', 'error', {
                    duration: 2000,
                    sound: false
                });
                return;
            }
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '‚è≥ Memproses...';
            
            try {
                console.log('üí≥ Processing withdrawal request:', {
                    amount: jumlah,
                    method: metode,
                    account_number: nomor_rekening.slice(-4) + '****'
                });
                
                const response = await fetch(window.API_BASE_URL + '/api/v1/withdrawal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        init_data: tg.initData,
                        amount: jumlah,
                        payment_method: metode,
                        account_number: nomor_rekening,
                        account_name: nama_pemilik
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Withdrawal request accepted');
                    
                    notification.success('‚úÖ Request penarikan berhasil diajukan!\n\nKami akan memproses dalam maksimal 1x24 jam.', 'success', {
                        duration: 5000,
                        sound: false
                    });
                    
                    // Reset form
                    e.target.reset();
                    
                    // Close mini app setelah 2 detik
                    setTimeout(() => {
                        tg.close();
                    }, 2000);
                } else {
                    const errMsg = result.detail || 'Terjadi kesalahan';
                    console.error('‚ùå Withdrawal failed:', errMsg);
                    notification.error(`‚ùå Gagal: ${errMsg}`, 'error', {
                        duration: 3000,
                        sound: false
                    });
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            } catch (error) {
                console.error('‚ùå Error submitting withdrawal:', error);
                notification.error(`‚ùå Gagal menghubungi server: ${error.message}`, 'error', {
                    duration: 3000,
                    sound: false
                });
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        function copyLink() {
            try {
                const link = getCachedElement('referral-link');
                
                if (!link.value) {
                    notification.error('‚ùå Link referral belum siap. Silakan tunggu...', 'error', {
                        duration: 2000,
                        sound: false
                    });
                    return;
                }
                
                // Use modern Clipboard API jika available, fallback ke exec command
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(link.value).then(() => {
                        console.log('‚úÖ Link copied via Clipboard API');
                        notification.success('‚úÖ Link referral disalin ke clipboard!', 'success', {
                            duration: 2000,
                            sound: false
                        });
                    }).catch(() => {
                        // Fallback ke old method
                        fallbackCopyLink(link);
                    });
                } else {
                    // Fallback ke old method
                    fallbackCopyLink(link);
                }
            } catch (error) {
                console.error('‚ùå Error copying link:', error);
                notification.error(`‚ùå Gagal menyalin link: ${error.message}`, 'error', {
                    duration: 2000,
                    sound: false
                });
            }
        }
        
        function fallbackCopyLink(link) {
            try {
                link.select();
                if (document.execCommand('copy')) {
                    console.log('‚úÖ Link copied via execCommand');
                    notification.success('‚úÖ Link referral disalin ke clipboard!', 'success', {
                        duration: 2000,
                        sound: false
                    });
                } else {
                    throw new Error('execCommand gagal');
                }
            } catch (error) {
                console.error('‚ùå Fallback copy failed:', error);
                notification.error('‚ùå Gagal menyalin link. Silakan copy manual dari input.', 'error', {
                    duration: 2000,
                    sound: false
                });
            }
        }
        
        // Cleanup function to prevent memory leaks
        function cleanup() {
            console.log('üßπ Cleaning up resources...');
            
            // Clear cached elements
            cachedElements = {};
            
            console.log('‚úÖ Cleanup complete');
        }
        
        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanup);
        window.addEventListener('pagehide', cleanup);
    </script>
    <script src="cache-manager.js?v=222222222"></script>
</body>
</html>
