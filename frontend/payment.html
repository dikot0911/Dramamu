<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Beli VIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="premium-styles.css">
    <style>
        body { 
            background: linear-gradient(180deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #E5E7EB; 
            font-family: 'Manrope', sans-serif;
            position: relative;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        header {
            background: rgba(26, 26, 46, 0.95) !important;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3) !important;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.1) !important;
        }
        
        nav a {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        nav a:hover {
            color: #d4af37 !important;
            transform: scale(1.1);
        }

        /* QRIS Modal Styles - Optimized with Light Animations */
        .qris-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            overflow-y: auto;
            will-change: opacity, visibility;
        }

        .qris-modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .qris-modal-container {
            position: relative;
            max-width: 340px;
            width: 100%;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
            border-radius: 18px;
            border: 2px solid rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.2);
            padding: 0.9rem;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.35s ease;
            will-change: transform, opacity;
        }

        /* Hide scrollbar */
        .qris-modal-container::-webkit-scrollbar {
            display: none;
        }

        .qris-modal-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .qris-modal-backdrop.active .qris-modal-container {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Light glow effect using opacity only (GPU accelerated) */
        .qris-modal-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(139, 92, 246, 0.05));
            border-radius: 20px;
            pointer-events: none;
            animation: light-glow 3s ease-in-out infinite;
            will-change: opacity;
        }

        @keyframes light-glow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .qris-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 8px;
            color: #d4af37;
            font-size: 0.8125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .qris-close-btn:hover {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.4), rgba(139, 92, 246, 0.3));
            border-color: rgba(212, 175, 55, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .qris-close-btn:active {
            transform: translateY(0);
        }

        .qris-header {
            text-align: center;
            margin-bottom: 0.65rem;
        }

        .qris-header h2 {
            font-size: 1rem;
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 0.25rem;
            animation: fade-in 0.5s ease 0.2s both;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .qris-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.7rem;
        }

        .qris-image-container {
            position: relative;
            margin: 0.65rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* QRIS Image with Glow Animation */
        .qris-image-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s, opacity 0.4s ease 0.1s;
            will-change: transform, opacity;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .qris-modal-backdrop.active .qris-image-wrapper {
            transform: scale(1);
            opacity: 1;
        }

        /* Subtle shine effect */
        .qris-image-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, transparent 50%, rgba(139, 92, 246, 0.1) 100%);
            animation: subtle-shine 4s ease-in-out infinite;
            will-change: opacity;
            pointer-events: none;
        }

        @keyframes subtle-shine {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.4; }
        }

        .qris-image {
            display: block;
            max-width: 100%;
            width: 100%;
            max-width: 210px;
            height: auto;
            border-radius: 10px;
            border: 2px solid rgba(212, 175, 55, 0.4);
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.15);
            position: relative;
            z-index: 1;
            transition: filter 0.3s ease;
            will-change: filter;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        .qris-modal-backdrop.active .qris-image {
            animation: pulse-glow 2.5s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.05); }
        }

        .qris-instructions {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 0.6rem;
            margin-top: 0.6rem;
        }

        .qris-instructions h3 {
            font-size: 0.7rem;
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 0.45rem;
            text-align: center;
        }

        .qris-instructions ol {
            list-style: none;
            counter-reset: instruction-counter;
            padding: 0;
            margin: 0;
        }

        .qris-instructions li {
            counter-increment: instruction-counter;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.3rem;
            padding-left: 1.3rem;
            position: relative;
            line-height: 1.3;
        }

        .qris-instructions li::before {
            content: counter(instruction-counter);
            position: absolute;
            left: 0;
            width: 17px;
            height: 17px;
            background: linear-gradient(135deg, #d4af37, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.6rem;
            color: #0f0f1e;
        }

        .qris-price {
            text-align: center;
            margin-top: 0.6rem;
            padding: 0.6rem;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(139, 92, 246, 0.15));
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .qris-price p {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.15rem;
        }

        .qris-price h3 {
            font-size: 1.15rem;
            font-weight: 700;
            color: #d4af37;
        }

        @media (max-width: 480px) {
            .qris-modal-backdrop {
                padding: 8px;
            }

            .qris-modal-container {
                max-width: 100%;
                padding: 0.75rem;
                border-radius: 14px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .qris-header {
                margin-bottom: 0.5rem;
            }

            .qris-header h2 {
                font-size: 0.95rem;
                margin-bottom: 0.25rem;
            }

            .qris-header p {
                font-size: 0.7rem;
            }

            .qris-image-container {
                margin: 0.5rem 0;
            }

            .qris-image {
                max-width: 160px;
            }

            .qris-price {
                padding: 0.5rem;
                margin-top: 0.5rem;
            }

            .qris-price p {
                font-size: 0.7rem;
                margin-bottom: 0.125rem;
            }

            .qris-price h3 {
                font-size: 1.1rem;
            }

            .qris-instructions {
                padding: 0.5rem;
                margin-top: 0.5rem;
            }

            .qris-instructions h3 {
                font-size: 0.7rem;
                margin-bottom: 0.375rem;
            }

            .qris-instructions li {
                font-size: 0.65rem;
                margin-bottom: 0.25rem;
                padding-left: 1.25rem;
            }

            .qris-instructions li::before {
                width: 16px;
                height: 16px;
                font-size: 0.625rem;
            }

            .qris-close-btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
                top: 0.5rem;
                right: 0.5rem;
            }
        }

        /* Mobile-specific optimizations */
        @media (max-width: 480px) {
            .screenshot-upload-section {
                padding: 0.5rem !important;
                margin-top: 0.5rem !important;
                border-radius: 8px !important;
            }

            .screenshot-title {
                font-size: 0.65rem !important;
                margin-bottom: 0.375rem !important;
            }

            .screenshot-button {
                padding: 0.425rem !important;
                font-size: 0.65rem !important;
            }

            .order-id-section {
                padding: 0.425rem !important;
                margin-top: 0.5rem !important;
            }

            .submit-payment-btn {
                padding: 0.625rem !important;
                margin-top: 0.625rem !important;
                font-size: 0.8rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="w-full h-screen overflow-hidden relative flex flex-col">
        <header class="w-full z-20 py-3 text-center relative">
            <h1 class="text-xl font-bold tracking-wide">Beli VIP</h1>
            <!-- History Button - Pojok Kanan Atas -->
            <button onclick="openHistoryModal()" id="historyBtn" style="position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(139, 92, 246, 0.2)); border: 1px solid rgba(212, 175, 55, 0.4); border-radius: 8px; padding: 6px 12px; color: #d4af37; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; z-index: 30;" onmouseover="this.style.background='linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(139, 92, 246, 0.3))'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(139, 92, 246, 0.2))'; this.style.transform='translateY(0)'">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span id="historyCount"></span>
            </button>
        </header>
        
        <main class="flex-1 overflow-y-auto scrollbar-hide p-4 pb-24">
            <div class="max-w-md mx-auto">
                <!-- DEBUG: Test Notification -->
                <div style="display: none;" id="debugPanel" class="mb-4 p-3 bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg">
                    <p class="text-xs text-yellow-200 mb-2">üß™ Debug Panel (Ctrl+D to toggle)</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="testNotification('success')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">‚úì Success</button>
                        <button onclick="testNotification('error')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">‚úó Error</button>
                        <button onclick="testNotification('pending')" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">‚è≥ Pending</button>
                        <button onclick="testNotification('info')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">‚Ñπ Info</button>
                    </div>
                </div>

                <div class="mb-6 text-center">
                    <h1 class="text-2xl font-bold text-white mb-2">üíé Pilih Paket VIP</h1>
                    <p class="text-sm text-gray-400">Akses unlimited semua drama premium</p>
                </div>

                <div class="space-y-3">
                    <div class="luxury-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-white text-lg">1 Hari</h2>
                                <p class="text-sm text-gray-400">VIP 1 Hari</p>
                            </div>
                            <button onclick="tampilkanQRIS(2000, 'VIP 1 Hari')" class="premium-btn">
                                Rp 2.000
                            </button>
                        </div>
                    </div>

                    <div class="luxury-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-white text-lg">3 Hari</h2>
                                <p class="text-sm text-gray-400">VIP 3 Hari</p>
                            </div>
                            <button onclick="tampilkanQRIS(5000, 'VIP 3 Hari')" class="premium-btn">
                                Rp 5.000
                            </button>
                        </div>
                    </div>
                    
                    <div class="luxury-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-white text-lg">7 Hari</h2>
                                <p class="text-sm text-gray-400">VIP 7 Hari</p>
                            </div>
                            <button onclick="tampilkanQRIS(10000, 'VIP 7 Hari')" class="premium-btn">
                                Rp 10.000
                            </button>
                        </div>
                    </div>

                    <div class="luxury-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-white text-lg">30 Hari</h2>
                                <p class="text-sm text-gray-400">VIP 30 Hari</p>
                            </div>
                            <button onclick="tampilkanQRIS(30000, 'VIP 30 Hari')" class="premium-btn">
                                Rp 30.000
                            </button>
                        </div>
                    </div>

                    <div class="luxury-card" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(139, 92, 246, 0.2)); border: 2px solid rgba(255, 215, 0, 0.4);">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-white text-lg">180 Hari <span style="font-size: 0.7em; color: #ffd700;">(6 Bulan)</span></h2>
                                <p class="text-sm text-gray-400">VIP 180 Hari - Best Value!</p>
                            </div>
                            <button onclick="tampilkanQRIS(150000, 'VIP 180 Hari')" class="premium-btn" style="background: linear-gradient(135deg, #ffd700, #ff8c00);">
                                Rp 150.000
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- QRIS Modal -->
    <div id="qrisModal" class="qris-modal-backdrop">
        <div class="qris-modal-container">
            <div class="qris-close-btn" onclick="tutupQRIS()">Close</div>
            
            <div class="qris-header">
                <h2 id="qrisTitle">Scan QRIS untuk Bayar</h2>
                <p id="qrisSubtitle">Paket VIP</p>
            </div>

            <div class="qris-image-container">
                <div class="qris-image-wrapper">
                    <img id="qrisImage" src="" alt="QRIS Code" class="qris-image">
                </div>
            </div>

            <div class="qris-price">
                <p>Total Pembayaran</p>
                <h3 id="qrisAmount">Rp 0</h3>
            </div>

            <!-- Order ID & Countdown Timer Section (2 kolom) -->
            <div class="order-id-timer-section" style="display: flex; gap: 0.5rem; margin-top: 0.55rem;">
                <!-- Kolom Kiri: Order ID -->
                <div style="flex: 1; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.4rem; text-align: center;">
                    <p style="font-size: 0.55rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.1rem;">Order ID</p>
                    <p id="qrisOrderId" style="font-size: 0.65rem; font-weight: 700; color: #8b5cf6; font-family: 'Courier New', monospace; letter-spacing: 0.3px;">-</p>
                </div>
                
                <!-- Kolom Kanan: Timer -->
                <div id="qrisCountdown" style="flex: 1; background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; padding: 0.4rem; text-align: center;">
                    <p style="font-size: 0.55rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.1rem;">‚è±Ô∏è Waktu</p>
                    <h3 id="qrisTimer" style="font-size: 0.75rem; font-weight: 700; color: #ff6b6b; font-family: 'Courier New', monospace; letter-spacing: 0.5px;">--:--:--</h3>
                    <p id="qrisExpiredWarning" style="font-size: 0.5rem; color: rgba(255, 107, 107, 0.9); margin-top: 0.1rem; display: none; font-weight: 600;">Expired!</p>
                </div>
            </div>

            <!-- Screenshot Upload Section -->
            <div class="screenshot-upload-section" style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 0.5rem; margin-top: 0.55rem;">
                <p class="screenshot-title" style="font-size: 0.65rem; color: rgba(255, 255, 255, 0.8); margin-bottom: 0.35rem; font-weight: 600;">üì∏ Upload Screenshot (Opsional)</p>
                <div style="position: relative;">
                    <input type="file" id="screenshotInput" accept="image/*" style="display: none;">
                    <button onclick="document.getElementById('screenshotInput').click()" class="screenshot-button" style="width: 100%; padding: 0.4rem; background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(139, 92, 246, 0.2)); border: 2px dashed rgba(212, 175, 55, 0.5); border-radius: 6px; color: rgba(255, 255, 255, 0.8); cursor: pointer; font-size: 0.65rem; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(212, 175, 55, 0.4), rgba(139, 92, 246, 0.3))'; this.style.borderColor='rgba(212, 175, 55, 0.7)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(139, 92, 246, 0.2))'; this.style.borderColor='rgba(212, 175, 55, 0.5)'">
                        üìÅ Pilih File
                    </button>
                    <p id="screenshotName" style="font-size: 0.6rem; color: rgba(255, 255, 255, 0.5); margin-top: 0.3rem; text-align: center;">Belum ada file</p>
                </div>
            </div>

            <div class="qris-instructions">
                <h3>üì± Cara Pembayaran</h3>
                <ol id="qrisInstructions">
                    <li>Buka aplikasi e-wallet atau mobile banking Anda</li>
                    <li>Pilih menu Scan QRIS</li>
                    <li>Scan kode QR di atas</li>
                    <li>Konfirmasi pembayaran sesuai nominal</li>
                    <li>Screenshot bukti pembayaran bersama Order ID di atas</li>
                    <li>Klik tombol "Cek Pembayaran" di bawah untuk verifikasi status</li>
                </ol>
            </div>

            <!-- Cek Status Pembayaran Button -->
            <button onclick="checkPaymentStatus()" class="submit-payment-btn" style="width: 100%; padding: 0.65rem; margin-top: 0.6rem; background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(139, 92, 246, 0.15)); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; color: #3b82f6; font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onmouseover="this.style.background='linear-gradient(135deg, rgba(212, 175, 55, 0.25), rgba(139, 92, 246, 0.25))'; this.style.borderColor='rgba(212, 175, 55, 0.5)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(139, 92, 246, 0.15))'; this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.transform='translateY(0)'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                Cek Status Pembayaran
            </button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="qris-modal-backdrop" style="display: none;">
        <div class="qris-modal-container" style="max-width: 380px;">
            <div class="qris-close-btn" onclick="closeHistoryModal()">Close</div>
            
            <div class="qris-header">
                <h2>üìã Riwayat Transaksi</h2>
            </div>

            <!-- Tabs -->
            <div id="historyTabs" style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                <button onclick="switchHistoryTab('ongoing')" id="tabOngoing" class="history-tab active" style="flex: 1; padding: 0.6rem 0.75rem; background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(139, 92, 246, 0.2)); border: 2px solid rgba(212, 175, 55, 0.5); border-radius: 8px; color: #d4af37; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                    ‚è≥ Berlangsung <span id="ongoingCount" style="background: rgba(255, 217, 61, 0.3); padding: 1px 6px; border-radius: 10px; margin-left: 4px; font-size: 0.65rem;">0</span>
                </button>
                <button onclick="switchHistoryTab('completed')" id="tabCompleted" class="history-tab" style="flex: 1; padding: 0.6rem 0.75rem; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.6)); border: 1px solid rgba(100, 100, 100, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    ‚úì Selesai <span id="completedCount" style="background: rgba(100, 100, 100, 0.3); padding: 1px 6px; border-radius: 10px; margin-left: 4px; font-size: 0.65rem;">0</span>
                </button>
            </div>

            <div id="historyList" style="margin-top: 0.75rem; max-height: 55vh; overflow-y: auto;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <script src="navbar.js?v=222222222"></script>

    <script>
        const tg = window.Telegram?.WebApp;
        if (!tg) {
            console.warn('‚ö†Ô∏è Telegram WebApp not available');
            alert('Error: Halaman ini harus dibuka melalui Telegram Mini App');
        } else {
            tg.ready();
            tg.enableClosingConfirmation();
            tg.disableVerticalSwipes();
            console.log("üîí Vertical swipes disabled - mini app tidak akan close saat scroll");
        }

        const user = tg?.initDataUnsafe?.user;
        if (!user || !user.id) {
            console.warn('‚ö†Ô∏è Telegram user data not available');
        }
        const telegram_id = user?.id || 'unknown';

        function formatRupiah(amount) {
            return 'Rp ' + amount.toLocaleString('id-ID');
        }

        let currentOrderData = null;
        let paymentStatusChecker = null;
        let countdownInterval = null;
        let paymentConfig = null;

        async function loadPaymentConfig() {
            try {
                const apiUrl = window.API_BASE_URL + '/api/v1/payment-config';
                const response = await fetch(apiUrl);
                if (response.ok) {
                    paymentConfig = await response.json();
                    console.log('üí≥ Payment config loaded:', paymentConfig);
                }
            } catch (error) {
                console.error('Error loading payment config:', error);
            }
        }

        loadPaymentConfig();

        async function tampilkanQRIS(harga, namaPaket) {
            console.log(`Menampilkan QRIS untuk: ${namaPaket} (${formatRupiah(harga)})`);
            
            try {
                notification.info('‚è≥ Loading QRIS...', 'info', {
                    duration: 60000
                });

                const paymentData = {
                    telegram_id: telegram_id,
                    paket_id: 1,
                    gross_amount: harga,
                    nama_paket: namaPaket
                };

                const apiUrl = window.API_BASE_URL + '/api/v1/create_payment';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Gagal membuat QRIS payment');
                }

                const data = await response.json();
                
                console.log(`‚úÖ QRIS payment created:`, data);

                const isManualVerification = paymentConfig?.active_gateway === 'qris-interactive';

                // Save order data
                currentOrderData = {
                    orderId: data.order_id,
                    transactionId: data.transaction_id,
                    harga: harga,
                    namaPaket: namaPaket,
                    expiresAt: data.expires_at
                };

                // Update modal content
                document.getElementById('qrisSubtitle').textContent = namaPaket;
                document.getElementById('qrisAmount').textContent = formatRupiah(harga);
                document.getElementById('qrisOrderId').textContent = data.transaction_id || data.order_id;

                const checkPaymentBtn = document.querySelector('.submit-payment-btn');
                const screenshotSection = document.querySelector('.screenshot-upload-section');
                const instructionList = document.getElementById('qrisInstructions');
                
                if (isManualVerification) {
                    if (checkPaymentBtn) checkPaymentBtn.style.display = 'none';
                    if (screenshotSection) screenshotSection.style.display = 'block';
                    if (instructionList) {
                        instructionList.innerHTML = `
                            <li>Buka aplikasi E-Wallet (DANA, GoPay, OVO, ShopeePay, dll)</li>
                            <li>Pilih menu Scan QRIS</li>
                            <li>Scan kode QR di atas</li>
                            <li>Konfirmasi pembayaran sesuai nominal</li>
                            <li><b>WAJIB</b>: Screenshot bukti pembayaran</li>
                            <li>Upload screenshot di form di atas</li>
                            <li>Tunggu verifikasi admin (maks 1x24 jam)</li>
                        `;
                    }
                } else {
                    if (checkPaymentBtn) checkPaymentBtn.style.display = 'flex';
                    if (screenshotSection) screenshotSection.style.display = 'block';
                    if (instructionList) {
                        instructionList.innerHTML = `
                            <li>Buka aplikasi E-Wallet (DANA, GoPay, OVO, ShopeePay, dll)</li>
                            <li>Pilih menu Scan QRIS</li>
                            <li>Scan kode QR di atas</li>
                            <li>Konfirmasi pembayaran sesuai nominal</li>
                            <li>Screenshot bukti pembayaran bersama Order ID di atas</li>
                            <li>Klik tombol "Cek Pembayaran" di bawah untuk verifikasi status</li>
                        `;
                    }
                }

                // Show modal dengan animasi
                const modal = document.getElementById('qrisModal');
                modal.classList.add('active');
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';

                // Only start auto status checker for auto gateways (not for qris-interactive)
                if (!isManualVerification && data.transaction_id) {
                    startPaymentStatusChecker(data.transaction_id);
                }

                // Start countdown timer
                if (data.expires_at) {
                    startCountdownTimer(data.expires_at);
                }

                // Track when modal animation completes (350ms transition)
                const modalAnimationTime = Date.now();
                const MODAL_ANIMATION_DURATION = 400;

                // Set image src and wait for BOTH modal animation AND image load before showing success
                const qrisImg = document.getElementById('qrisImage');
                qrisImg.onload = function() {
                    const elapsed = Date.now() - modalAnimationTime;
                    const remainingDelay = Math.max(0, MODAL_ANIMATION_DURATION - elapsed);
                    
                    setTimeout(() => {
                        notification.close();
                        if (isManualVerification) {
                            notification.success('‚úÖ Kode Pembayaran Siap!\n\nSetelah bayar, upload screenshot untuk verifikasi admin.', 'success', {
                                duration: 4000
                            });
                        } else {
                            notification.success('‚úÖ Kode Pembayaran Siap!\n\nSilakan scan untuk melakukan pembayaran.', 'success', {
                                duration: 3000
                            });
                        }
                    }, remainingDelay);
                };
                qrisImg.onerror = function() {
                    const elapsed = Date.now() - modalAnimationTime;
                    const remainingDelay = Math.max(0, MODAL_ANIMATION_DURATION - elapsed);
                    
                    setTimeout(() => {
                        notification.close();
                        notification.error('‚ùå Gagal memuat gambar QRIS\n\nSilakan coba lagi.', 'error', {
                            duration: 3000
                        });
                    }, remainingDelay);
                };
                qrisImg.src = data.qris_url;

            } catch (error) {
                console.error('Error creating QRIS payment:', error);
                notification.error('‚ùå Terjadi Kesalahan\n\nMohon maaf, silakan coba beberapa saat lagi.', 'error', {
                    duration: 3000,
                    sound: true,
                    soundType: 'error'
                });
            }
        }

        let pollingStartTime = null;
        let pollErrorCount = 0;
        const FAST_POLL_INTERVAL = 3000;  // 3 detik untuk 60 detik pertama
        const NORMAL_POLL_INTERVAL = 5000; // 5 detik setelahnya
        const FAST_POLL_DURATION = 60000;  // Durasi polling cepat: 60 detik

        function startPaymentStatusChecker(transactionId) {
            // Clear existing checker
            if (paymentStatusChecker) {
                clearInterval(paymentStatusChecker);
            }

            console.log(`üîç Starting payment status checker for: ${transactionId}`);
            pollingStartTime = Date.now();
            pollErrorCount = 0;

            // Fungsi untuk cek status sekali
            async function checkOnce() {
                try {
                    const apiUrl = window.API_BASE_URL + `/api/v1/check_payment_status?transaction_id=${transactionId}`;
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        console.error('Failed to check payment status');
                        pollErrorCount++;
                        return;
                    }

                    pollErrorCount = 0; // Reset error count on success
                    const result = await response.json();
                    console.log('Payment status:', result.status);

                    if (result.status === 'paid' || result.status === 'success') {
                        // Payment success!
                        clearInterval(paymentStatusChecker);
                        paymentStatusChecker = null;

                        notification.success('üéâ Pembayaran Berhasil!\n\nAkses VIP Anda sudah aktif!\nSelamat menikmati semua konten premium kami üé¨', 'success', {
                            duration: 4000,
                            sound: true,
                            vibrate: true,
                            soundType: 'payment'
                        });

                        // Auto-dismiss success notification after 4 seconds
                        setTimeout(() => {
                            notification.close();
                        }, 4000);

                        // Close modal after 2 seconds
                        setTimeout(() => {
                            tutupQRIS();
                        }, 2000);
                        return true; // Signal success
                    } else if (result.status === 'expired') {
                        clearInterval(paymentStatusChecker);
                        paymentStatusChecker = null;

                        notification.error('‚è∞ Waktu Pembayaran Habis\n\nMohon maaf, waktu untuk pembayaran ini telah berakhir.\nSilakan buat transaksi baru untuk melanjutkan.', 'error', {
                            duration: 4000,
                            sound: true
                        });

                        setTimeout(() => {
                            tutupQRIS();
                        }, 4000);
                        return true; // Signal done (expired)
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking payment status:', error);
                    pollErrorCount++;
                    return false;
                }
            }

            // Start dengan polling cepat (3 detik)
            function startPolling() {
                const elapsed = Date.now() - pollingStartTime;
                const interval = elapsed < FAST_POLL_DURATION ? FAST_POLL_INTERVAL : NORMAL_POLL_INTERVAL;
                
                console.log(`‚è±Ô∏è Polling interval: ${interval}ms (elapsed: ${elapsed}ms)`);
                
                paymentStatusChecker = setInterval(async () => {
                    const done = await checkOnce();
                    if (done) return;
                    
                    // Jika sudah lebih dari 60 detik dan masih pakai fast polling, switch ke normal
                    const currentElapsed = Date.now() - pollingStartTime;
                    if (currentElapsed >= FAST_POLL_DURATION && interval === FAST_POLL_INTERVAL) {
                        console.log('‚è±Ô∏è Switching to normal polling interval (5s)');
                        clearInterval(paymentStatusChecker);
                        startPolling(); // Restart dengan interval baru
                    }
                }, interval);
            }
            
            // Langsung cek sekali pertama kali
            checkOnce();
            startPolling();
        }

        async function checkPaymentStatus() {
            if (!currentOrderData || !currentOrderData.transactionId) {
                notification.error('‚ùå Terjadi Kesalahan\n\nSilakan tutup dan buka kembali halaman pembayaran.', 'error', {
                    duration: 3000
                });
                return;
            }

            try {
                // Show loading
                notification.info('üîç Mengecek Pembayaran...', 'info', {
                    duration: 2000
                });

                const apiUrl = window.API_BASE_URL + `/api/v1/check_payment_status?transaction_id=${currentOrderData.transactionId}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error('Gagal memeriksa status pembayaran');
                }

                const result = await response.json();
                console.log('Manual check payment status:', result);

                // Check if result has data property
                const paymentData = result.data || result;
                const status = paymentData.status || result.status;

                if (status === 'paid' || status === 'success') {
                    // Payment successful - show notification with sound
                    notification.success('üéâ Pembayaran Berhasil!\n\nAkses VIP Anda sudah aktif!\nSelamat menikmati semua konten premium kami üé¨', 'success', {
                        duration: 4000,
                        sound: true,
                        vibrate: true,
                        soundType: 'payment'
                    });

                    // Stop auto-checker
                    if (paymentStatusChecker) {
                        clearInterval(paymentStatusChecker);
                        paymentStatusChecker = null;
                    }

                    // Auto-dismiss success notification after 4 seconds (override manual-only behavior)
                    setTimeout(() => {
                        notification.close();
                    }, 4000);

                    // Close modal after 2 seconds (before notification auto-dismiss)
                    setTimeout(() => {
                        tutupQRIS();
                    }, 2000);
                } else if (status === 'pending') {
                    // Still pending - manual dismiss required
                    notification.pending('‚è≥ Pembayaran Sedang Diproses\n\nMohon tunggu sebentar.\nAnda bisa cek kembali dalam beberapa saat.');
                } else if (status === 'expired') {
                    // Expired
                    notification.error('‚è∞ Waktu Pembayaran Habis\n\nMohon maaf, waktu untuk pembayaran ini telah berakhir.\nSilakan buat transaksi baru untuk melanjutkan.', 'error', {
                        duration: 4000,
                        sound: true
                    });

                    // Stop auto-checker
                    if (paymentStatusChecker) {
                        clearInterval(paymentStatusChecker);
                        paymentStatusChecker = null;
                    }
                } else if (status === 'failed' || status === 'cancelled') {
                    // Failed
                    notification.error('‚ùå Pembayaran Tidak Berhasil\n\nMohon maaf, transaksi Anda tidak dapat diproses.\nSilakan coba lagi atau hubungi customer service.', 'error', {
                        duration: 4000,
                        sound: true
                    });

                    // Stop auto-checker
                    if (paymentStatusChecker) {
                        clearInterval(paymentStatusChecker);
                        paymentStatusChecker = null;
                    }
                } else {
                    // Unknown status - treat as pending
                    notification.pending('‚ÑπÔ∏è Pembayaran Sedang Diproses\n\nMohon tunggu sebentar.\nJika ada kendala, silakan hubungi customer service kami.');
                }

            } catch (error) {
                console.error('Error checking payment status:', error);
                notification.error('‚ùå Tidak Dapat Mengecek Status\n\nSilakan coba lagi dalam beberapa saat.', 'error', {
                    duration: 3000,
                    sound: true
                });
            }
        }

        function startCountdownTimer(expiresAt) {
            // Clear existing countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const timerElement = document.getElementById('qrisTimer');
            const warningElement = document.getElementById('qrisExpiredWarning');
            const countdownBox = document.getElementById('qrisCountdown');
            
            if (!timerElement || !warningElement || !countdownBox) {
                console.warn('‚ö†Ô∏è Countdown elements not found, skipping timer');
                return;
            }
            
            // Hide warning initially
            warningElement.style.display = 'none';

            function updateCountdown() {
                const now = new Date().getTime();
                const expiryTime = new Date(expiresAt).getTime();
                const timeLeft = expiryTime - now;

                if (timeLeft <= 0) {
                    // Expired
                    timerElement.textContent = '00:00:00';
                    timerElement.style.color = '#ff4444';
                    warningElement.style.display = 'block';
                    countdownBox.style.borderColor = 'rgba(255, 68, 68, 0.6)';
                    countdownBox.style.background = 'linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(255, 107, 107, 0.2))';
                    
                    // Stop countdown
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    
                    console.log('‚è∞ QRIS payment expired');
                    return;
                }

                // Calculate time components
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                // Format with leading zeros
                const formatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerElement.textContent = formatted;

                // Change color based on time left
                if (timeLeft < 5 * 60 * 1000) {
                    // Less than 5 minutes - red warning
                    timerElement.style.color = '#ff4444';
                    countdownBox.style.borderColor = 'rgba(255, 68, 68, 0.6)';
                } else if (timeLeft < 15 * 60 * 1000) {
                    // Less than 15 minutes - orange warning
                    timerElement.style.color = '#ff9f40';
                    countdownBox.style.borderColor = 'rgba(255, 159, 64, 0.5)';
                } else {
                    // Normal - green/yellow
                    timerElement.style.color = '#ffd93d';
                    countdownBox.style.borderColor = 'rgba(255, 217, 61, 0.4)';
                }
            }

            // Update immediately
            updateCountdown();

            // Update every second
            countdownInterval = setInterval(updateCountdown, 1000);
            console.log('‚è±Ô∏è Countdown timer started');
        }

        function tutupQRIS() {
            const modal = document.getElementById('qrisModal');
            modal.classList.remove('active');
            
            // Clear payment status checker
            if (paymentStatusChecker) {
                clearInterval(paymentStatusChecker);
                paymentStatusChecker = null;
                console.log('üõë Payment status checker stopped');
            }
            
            // Clear countdown timer
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                console.log('üõë Countdown timer stopped');
            }
            
            // Restore body scroll
            document.body.style.overflow = '';
            
            // Reset order data
            currentOrderData = null;
        }

        // Close modal saat klik backdrop
        document.getElementById('qrisModal').addEventListener('click', function(e) {
            if (e.target === this) {
                tutupQRIS();
            }
        });

        // Close modal dengan ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                tutupQRIS();
            }
        });

        // Handle screenshot file input change
        document.getElementById('screenshotInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            const nameDisplay = document.getElementById('screenshotName');
            const uploadButton = document.querySelector('.screenshot-button');
            
            if (!file) {
                nameDisplay.textContent = 'Belum ada file';
                nameDisplay.style.color = 'rgba(255, 255, 255, 0.5)';
                return;
            }

            if (!currentOrderData || !currentOrderData.transactionId) {
                notification.error('‚ùå Terjadi Kesalahan\n\nSilakan tutup dan buka kembali halaman pembayaran.', 'error', {
                    duration: 3000
                });
                return;
            }

            // Show uploading status
            nameDisplay.textContent = '‚è≥ Mengupload...';
            nameDisplay.style.color = 'rgba(59, 130, 246, 0.8)';
            uploadButton.disabled = true;
            uploadButton.style.opacity = '0.6';
            uploadButton.style.cursor = 'not-allowed';

            try {
                // Create FormData and upload
                const formData = new FormData();
                formData.append('screenshot', file);
                formData.append('transaction_id', currentOrderData.transactionId);

                const apiUrl = window.API_BASE_URL + '/api/v1/upload_screenshot';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload gagal');
                }

                const result = await response.json();
                
                // Success - update UI
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                nameDisplay.textContent = `‚úÖ ${file.name} (${sizeMB} MB) - Terkirim`;
                nameDisplay.style.color = 'rgba(34, 197, 94, 0.8)';
                
                // Change button style to show upload success
                uploadButton.textContent = '‚úì Ganti Bukti Transaksi';
                uploadButton.style.border = '2px solid rgba(34, 197, 94, 0.6)';
                uploadButton.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.2))';
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';

                notification.success('‚úÖ Screenshot Terkirim!\n\nBukti pembayaran berhasil dikirim ke admin.', 'success', {
                    duration: 3000
                });

                console.log('‚úÖ Screenshot uploaded:', result.screenshot_url);

            } catch (error) {
                console.error('Error uploading screenshot:', error);
                nameDisplay.textContent = '‚ùå Upload gagal - Coba lagi';
                nameDisplay.style.color = 'rgba(239, 68, 68, 0.8)';
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';

                notification.error('‚ùå Upload Gagal\n\nSilakan coba lagi atau hubungi customer service.', 'error', {
                    duration: 3000
                });
            }
        });
        
        // History Modal Functions
        let ongoingPayments = [];
        let completedPayments = [];
        let currentHistoryTab = 'ongoing';

        async function loadPaymentHistory() {
            try {
                const initData = tg?.initData;
                if (!initData) {
                    console.warn('‚ö†Ô∏è No Telegram init data available');
                    return;
                }

                const apiUrl = window.API_BASE_URL + '/api/v1/payment_history';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init_data: initData })
                });

                if (!response.ok) {
                    throw new Error('Failed to load payment history');
                }

                const result = await response.json();
                ongoingPayments = result.ongoing || [];
                completedPayments = result.completed || [];
                
                // Update history button count (show total)
                const historyBtn = document.getElementById('historyCount');
                const totalCount = ongoingPayments.length + completedPayments.length;
                if (totalCount > 0) {
                    historyBtn.textContent = `(${totalCount})`;
                    historyBtn.style.display = 'inline';
                } else {
                    historyBtn.textContent = '';
                }

                // Update tab counts
                document.getElementById('ongoingCount').textContent = ongoingPayments.length;
                document.getElementById('completedCount').textContent = completedPayments.length;

                console.log(`‚úÖ Loaded ${ongoingPayments.length} ongoing, ${completedPayments.length} completed payments`);
            } catch (error) {
                console.error('Error loading payment history:', error);
            }
        }

        function switchHistoryTab(tab) {
            currentHistoryTab = tab;
            
            const tabOngoing = document.getElementById('tabOngoing');
            const tabCompleted = document.getElementById('tabCompleted');
            
            if (tab === 'ongoing') {
                tabOngoing.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(139, 92, 246, 0.2))';
                tabOngoing.style.border = '2px solid rgba(212, 175, 55, 0.5)';
                tabOngoing.style.color = '#d4af37';
                tabOngoing.style.fontWeight = '700';
                
                tabCompleted.style.background = 'linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.6))';
                tabCompleted.style.border = '1px solid rgba(100, 100, 100, 0.3)';
                tabCompleted.style.color = 'rgba(255, 255, 255, 0.6)';
                tabCompleted.style.fontWeight = '600';
            } else {
                tabCompleted.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(16, 185, 129, 0.2))';
                tabCompleted.style.border = '2px solid rgba(34, 197, 94, 0.5)';
                tabCompleted.style.color = '#22c55e';
                tabCompleted.style.fontWeight = '700';
                
                tabOngoing.style.background = 'linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.6))';
                tabOngoing.style.border = '1px solid rgba(100, 100, 100, 0.3)';
                tabOngoing.style.color = 'rgba(255, 255, 255, 0.6)';
                tabOngoing.style.fontWeight = '600';
            }
            
            displayHistoryList();
        }

        function openHistoryModal() {
            currentHistoryTab = 'ongoing';
            switchHistoryTab('ongoing');
            displayHistoryList();
            const modal = document.getElementById('historyModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            document.body.style.overflow = '';
        }

        function displayHistoryList() {
            const listContainer = document.getElementById('historyList');
            const payments = currentHistoryTab === 'ongoing' ? ongoingPayments : completedPayments;
            const emptyMessage = currentHistoryTab === 'ongoing' 
                ? 'Tidak ada transaksi berlangsung'
                : 'Tidak ada transaksi selesai';
            const emptyIcon = currentHistoryTab === 'ongoing' ? '‚è≥' : 'üì≠';
            
            if (!payments || payments.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.5);">
                        <p style="font-size: 2rem; margin-bottom: 0.5rem;">${emptyIcon}</p>
                        <p style="font-size: 0.85rem;">${emptyMessage}</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = payments.map(payment => {
                const statusColor = {
                    'pending': '#ffd93d',
                    'success': '#22c55e',
                    'failed': '#ff4444',
                    'expired': '#ff9f40',
                    'cancelled': '#999'
                }[payment.status] || '#999';

                const statusText = {
                    'pending': 'Pending',
                    'success': 'Sukses',
                    'failed': 'Gagal',
                    'expired': 'Expired',
                    'cancelled': 'Dibatalkan'
                }[payment.status] || payment.status;

                const dateToShow = payment.paid_at || payment.created_at;
                const displayDate = new Date(dateToShow);
                const formattedDate = displayDate.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const isClickable = currentHistoryTab === 'ongoing' && payment.status === 'pending';
                const clickHandler = isClickable ? `onclick="reopenTransaction('${payment.transaction_id}')"` : '';
                const cursorStyle = isClickable ? 'cursor: pointer;' : 'cursor: default;';
                const hoverEffect = isClickable 
                    ? `onmouseover="this.style.borderColor='rgba(212, 175, 55, 0.6)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.transform='translateY(0)'"` 
                    : '';

                return `
                    <div ${clickHandler} style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95)); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 10px; padding: 0.75rem; margin-bottom: 0.75rem; ${cursorStyle} transition: all 0.3s ease;" ${hoverEffect}>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.4rem;">
                            <div>
                                <p style="font-size: 0.8rem; font-weight: 700; color: #d4af37; margin-bottom: 0.2rem;">${payment.package_name}</p>
                                <p style="font-size: 0.65rem; color: rgba(255, 255, 255, 0.5); font-family: 'Courier New', monospace;">${payment.transaction_id}</p>
                            </div>
                            <span style="background: ${statusColor}; color: ${payment.status === 'success' ? '#fff' : '#0f0f1e'}; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">${statusText}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <p style="font-size: 0.85rem; font-weight: 700; color: #fff;">${formatRupiah(payment.amount)}</p>
                            <p style="font-size: 0.65rem; color: rgba(255, 255, 255, 0.5);">${formattedDate}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function reopenTransaction(transactionId) {
            const payment = ongoingPayments.find(p => p.transaction_id === transactionId);
            if (!payment) {
                console.error('Payment not found:', transactionId);
                return;
            }

            // Close history modal
            closeHistoryModal();

            // Wait for modal animation
            await new Promise(resolve => setTimeout(resolve, 300));

            // Set current order data
            currentOrderData = {
                orderId: payment.order_id,
                transactionId: payment.transaction_id,
                harga: payment.amount,
                namaPaket: payment.package_name,
                expiresAt: payment.expires_at
            };

            // Update QRIS modal content
            document.getElementById('qrisSubtitle').textContent = payment.package_name;
            document.getElementById('qrisAmount').textContent = formatRupiah(payment.amount);
            document.getElementById('qrisImage').src = payment.qris_url || '';
            document.getElementById('qrisOrderId').textContent = payment.transaction_id;

            // Show QRIS modal
            const modal = document.getElementById('qrisModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Start countdown timer if expires_at is available
            if (payment.expires_at) {
                startCountdownTimer(payment.expires_at);
            }

            // Start payment status checker
            startPaymentStatusChecker(payment.transaction_id);

            notification.info('üìÑ Transaksi Dibuka Kembali\n\nSilakan lanjutkan pembayaran Anda.', 'info', {
                duration: 3000
            });
        }

        // Load payment history on page load
        window.addEventListener('load', () => {
            loadPaymentHistory();
            // Refresh every 30 seconds
            setInterval(loadPaymentHistory, 30000);
        });

        // Close history modal when clicking backdrop
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHistoryModal();
            }
        });

        // Cleanup function to prevent memory leaks
        function cleanup() {
            console.log('üßπ Cleaning up resources...');
            document.body.style.overflow = '';
            console.log('‚úÖ Cleanup complete');
        }

        // Block all interactions on QR image
        function initQRISProtection() {
            const qrisImage = document.getElementById('qrisImage');
            if (!qrisImage) {
                setTimeout(initQRISProtection, 100);
                return;
            }
            
            // Block right-click context menu
            qrisImage.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, true);
            
            // Block long-press and all touch interactions
            qrisImage.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, { passive: false, capture: true });
            
            qrisImage.addEventListener('touchmove', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, { passive: false, capture: true });
            
            qrisImage.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, { passive: false, capture: true });
            
            // Block drag
            qrisImage.addEventListener('dragstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, true);
            
            // Block mouse down (for potential selection/context menu trigger)
            qrisImage.addEventListener('mousedown', function(e) {
                if (e.button === 2) { // Right-click
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);
        }
        
        // Start protection when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initQRISProtection);
        } else {
            initQRISProtection();
        }
        
        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanup);
        window.addEventListener('pagehide', cleanup);

        // DEBUG: Test notification function
        function testNotification(type) {
            console.log(`üß™ Testing notification: ${type}`);
            if (type === 'success') {
                notification.success('üéâ Test Success Notification\n\nWith sound & vibration', { sound: true, vibrate: true });
            } else if (type === 'error') {
                notification.error('‚ùå Test Error Notification\n\nWith sound & vibration', { sound: true, vibrate: true });
            } else if (type === 'pending') {
                notification.pending('‚è≥ Test Pending Notification\n\nManual dismiss required - With sound & vibration');
            } else if (type === 'info') {
                notification.info('‚ÑπÔ∏è Test Info Notification\n\nWith sound & vibration', { sound: true, vibrate: true });
            }
        }

        // DEBUG: Toggle debug panel with Ctrl+D
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                const panel = document.getElementById('debugPanel');
                const style = window.getComputedStyle(panel);
                panel.style.display = style.display === 'none' ? 'block' : 'none';
                console.log('üß™ Debug panel toggled');
            }
        });

        // DEBUG: Show debug panel on startup for testing
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
            document.getElementById('debugPanel').style.display = 'block';
            console.log('üß™ Debug panel enabled (localhost)');
        }
    </script>
    <script src="cache-manager.js?v=555555555"></script>
    <script src="notification.js?v=222222223"></script>
</body>
</html>
