<!DOCTYPE html>
<html lang="id" translate="no">
<head>
    <base href="/panel/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="google" content="notranslate">
    <title>Pengaturan - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-mobile.css">
    <script src="icons.js"></script>
    <script src="themeToggle.js"></script>
    <script src="sidebar.js"></script>
    <script src="expand.js"></script>
    <script src="confirm-modal.js"></script>
</head>
<body data-page="settings">
    <div class="admin-layout">
        <!-- Desktop Sidebar - Static (tidak reload) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="assets/logo-dramamu.jpg" alt="Dramamu Logo">
                </div>
                <h2>Dramamu Admin</h2>
                <p class="admin-subtitle">Panel Kontrol</p>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item" data-page="dashboard">
                    <span class="nav-icon" data-icon="dashboard" data-icon-size="md"></span>
                    <span>Dashboard</span>
                </a>
                <a href="analytics.html" class="nav-item" data-page="analytics">
                    <span class="nav-icon" data-icon="barChart" data-icon-size="md"></span>
                    <span>Analytics</span>
                </a>
                <a href="users.html" class="nav-item" data-page="users">
                    <span class="nav-icon" data-icon="users" data-icon-size="md"></span>
                    <span>Pengguna</span>
                </a>
                <a href="movies.html" class="nav-item" data-page="movies">
                    <span class="nav-icon" data-icon="movie" data-icon-size="md"></span>
                    <span>Drama</span>
                </a>
                <a href="requests.html" class="nav-item" data-page="requests">
                    <span class="nav-icon" data-icon="fileText" data-icon-size="md"></span>
                    <span>Permintaan</span>
                    <span class="request-notification-badge notification-badge"></span>
                </a>
                <a href="withdrawals.html" class="nav-item" data-page="withdrawals">
                    <span class="nav-icon" data-icon="dollarSign" data-icon-size="md"></span>
                    <span>Penarikan</span>
                    <span class="withdrawal-notification-badge notification-badge"></span>
                </a>
                <a href="payments.html" class="nav-item" data-page="payments">
                    <span class="nav-icon" data-icon="creditCard" data-icon-size="md"></span>
                    <span>Pembayaran</span>
                </a>
                <a href="settings.html" class="nav-item" data-page="settings">
                    <span class="nav-icon" data-icon="settings" data-icon-size="md"></span>
                    <span>Pengaturan</span>
                </a>
                <a href="admin-users.html" class="nav-item" data-page="admin-users" style="display: none;">
                    <span class="nav-icon" data-icon="shield" data-icon-size="md"></span>
                    <span>Admin Users</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="breadcrumb">
                    <span>Pengaturan</span>
                </div>
                <div class="header-actions">
                    <div id="themeToggleContainer"></div>
                    <div class="user-info">
                        <span data-icon="user" data-icon-size="sm" style="margin-right: 6px;"></span>
                        <span id="adminUsername">Admin</span>
                    </div>
                    <button class="btn btn-secondary" onclick="AdminPanel.logout()">
                        <span data-icon="logOut" data-icon-size="sm"></span>
                        <span>Logout</span>
                    </button>
                </div>
            </header>

            <div class="content">
                <div class="page-header">
                    <h1 class="page-title">Pengaturan Sistem</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" onclick="addNewSetting()">
                            <span data-icon="plus" data-icon-size="sm"></span>
                            <span>Tambah Setting</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Konfigurasi Aplikasi</h2>
                    </div>
                    <div class="card-body">
                        <div id="settingsList" class="loading">Memuat...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Fitur Broadcast & Export</h2>
                    </div>
                    <div class="card-body">
                        <div class="broadcast-section">
                            <h3>Broadcast Message</h3>
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                                Pilih tipe broadcast: Telegram (kirim ke user), atau Mini App (tampilkan di app).
                            </p>
                            <div class="form-group">
                                <label>Tipe Broadcast</label>
                                <select id="broadcastType" class="form-control">
                                    <option value="v1">Telegram (Kirim ke User)</option>
                                    <option value="v2">Mini App (Tampilkan di App)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Target Audience</label>
                                <select id="broadcastTarget" class="form-control">
                                    <option value="all">Semua User</option>
                                    <option value="vip">Hanya VIP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Pesan</label>
                                <textarea id="broadcastMessage" class="form-control" rows="5" placeholder="Tulis pesan broadcast..."></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="sendBroadcast()">
                                <span data-icon="send" data-icon-size="sm"></span>
                                <span>Kirim Broadcast</span>
                            </button>
                        </div>

                        <hr style="margin: 24px 0; border: 1px solid var(--border);">

                        <div class="broadcast-history-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3>Broadcast History</h3>
                                <button class="btn btn-secondary" onclick="loadBroadcastHistory()">
                                    <span data-icon="refreshCw" data-icon-size="sm"></span>
                                    <span>Refresh</span>
                                </button>
                            </div>
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                                Kelola broadcast yang telah dikirim. Anda dapat menyembunyikan atau menghapus broadcast.
                            </p>
                            <div id="broadcastHistoryList" class="loading">Memuat...</div>
                        </div>

                        <hr style="margin: 24px 0; border: 1px solid var(--border);">

                        <div class="export-section">
                            <h3>Export Data</h3>
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                                Download data dalam format CSV untuk analisis lebih lanjut.
                            </p>
                            <div class="export-buttons">
                                <button class="btn btn-secondary" onclick="exportData('users')">
                                    <span data-icon="download" data-icon-size="sm"></span>
                                    <span>Export Users</span>
                                </button>
                                <button class="btn btn-secondary" onclick="exportData('payments')">
                                    <span data-icon="download" data-icon-size="sm"></span>
                                    <span>Export Payments</span>
                                </button>
                                <button class="btn btn-secondary" onclick="exportData('withdrawals')">
                                    <span data-icon="download" data-icon-size="sm"></span>
                                    <span>Export Withdrawals</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tambah Setting</h2>
                <button class="close-btn" onclick="closeSettingModal()">
                    <span data-icon="x" data-icon-size="md"></span>
                </button>
            </div>
            <div class="modal-body">
                <form id="settingForm" onsubmit="saveSetting(event)">
                    <div class="form-group">
                        <label>Key</label>
                        <input type="text" id="settingKey" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <input type="text" id="settingValue" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea id="settingDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeSettingModal()">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="confirm-modal.js"></script>
    <script src="admin.js"></script>
    <script>
        let settings = [];

        async function loadSettings() {
            try {
                const response = await AdminPanel.apiCall('/admin/settings');
                settings = response.settings;
                displaySettings();
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settingsList').innerHTML = '<div class="empty-state">Gagal memuat settings</div>';
            }
        }

        function displaySettings() {
            const container = document.getElementById('settingsList');
            
            if (!settings || settings.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada setting. Klik "Tambah Setting" untuk membuat setting baru.</div>';
                return;
            }

            container.innerHTML = `
                <div class="settings-list">
                    ${settings.map(setting => `
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-key">${setting.key}</div>
                                <div class="setting-value">${setting.value || '-'}</div>
                                ${setting.description ? `<div class="setting-desc">${setting.description}</div>` : ''}
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="editSetting('${setting.key}')">
                                <span data-icon="edit" data-icon-size="sm"></span>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            if (window.initIcons) {
                initIcons();
            }
        }

        function addNewSetting() {
            document.getElementById('modalTitle').textContent = 'Tambah Setting';
            document.getElementById('settingKey').value = '';
            document.getElementById('settingValue').value = '';
            document.getElementById('settingDescription').value = '';
            document.getElementById('settingKey').readOnly = false;
            document.getElementById('settingModal').style.display = 'flex';
        }

        function editSetting(key) {
            const setting = settings.find(s => s.key === key);
            if (!setting) return;

            document.getElementById('modalTitle').textContent = 'Edit Setting';
            document.getElementById('settingKey').value = setting.key;
            document.getElementById('settingValue').value = setting.value || '';
            document.getElementById('settingDescription').value = setting.description || '';
            document.getElementById('settingKey').readOnly = true;
            document.getElementById('settingModal').style.display = 'flex';
        }

        function closeSettingModal() {
            document.getElementById('settingModal').style.display = 'none';
        }

        async function saveSetting(event) {
            event.preventDefault();

            const key = document.getElementById('settingKey').value;
            const value = document.getElementById('settingValue').value;
            const description = document.getElementById('settingDescription').value;

            try {
                await AdminPanel.apiCall(`/admin/settings/${key}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        key,
                        value,
                        description
                    })
                });

                AdminPanel.showToast('Setting berhasil disimpan', 'success');
                closeSettingModal();
                loadSettings();
            } catch (error) {
                console.error('Error saving setting:', error);
                AdminPanel.showToast('Gagal menyimpan setting', 'error');
            }
        }

        function showBroadcastResult(response) {
            const successCount = response.success_count || 0;
            const failedCount = response.failed_count || 0;
            const successList = response.success || [];
            const failedList = response.failed || [];
            
            const maxCollapsed = 3;
            const shouldCollapse = successCount > maxCollapsed || failedCount > maxCollapsed;
            
            let html = '<div class="broadcast-result">';
            html += `<div class="broadcast-summary">`;
            html += `<strong>${response.message}</strong>`;
            html += '</div>';
            
            if (successCount > 0) {
                html += '<div class="broadcast-section success-section">';
                html += `<div class="broadcast-header">`;
                html += `<span class="section-title">✓ Berhasil (${successCount})</span>`;
                if (successCount > maxCollapsed) {
                    html += `<button class="toggle-btn" onclick="toggleBroadcastList(this)" data-expanded="false">`;
                    html += `<span class="toggle-icon">▼</span>`;
                    html += `</button>`;
                }
                html += `</div>`;
                
                const displayList = shouldCollapse ? successList.slice(0, maxCollapsed) : successList;
                const remainingCount = successCount - maxCollapsed;
                
                html += `<div class="user-list ${shouldCollapse && successCount > maxCollapsed ? 'collapsed' : ''}">`;
                displayList.forEach(user => {
                    html += `<div class="user-item">@${user.username} (${user.telegram_id})</div>`;
                });
                
                if (shouldCollapse && successCount > maxCollapsed) {
                    html += `<div class="more-indicator">... dan ${remainingCount} lainnya</div>`;
                    html += `<div class="hidden-users" style="display: none;">`;
                    successList.slice(maxCollapsed).forEach(user => {
                        html += `<div class="user-item">@${user.username} (${user.telegram_id})</div>`;
                    });
                    html += `</div>`;
                }
                
                html += '</div>';
                html += '</div>';
            }
            
            if (failedCount > 0) {
                html += '<div class="broadcast-section failed-section">';
                html += `<div class="broadcast-header">`;
                html += `<span class="section-title">✗ Gagal (${failedCount})</span>`;
                if (failedCount > maxCollapsed) {
                    html += `<button class="toggle-btn" onclick="toggleBroadcastList(this)" data-expanded="false">`;
                    html += `<span class="toggle-icon">▼</span>`;
                    html += `</button>`;
                }
                html += `</div>`;
                
                const displayList = shouldCollapse ? failedList.slice(0, maxCollapsed) : failedList;
                const remainingCount = failedCount - maxCollapsed;
                
                html += `<div class="user-list ${shouldCollapse && failedCount > maxCollapsed ? 'collapsed' : ''}">`;
                displayList.forEach(user => {
                    html += `<div class="user-item">@${user.username} (${user.telegram_id})${user.error ? ` - ${user.error}` : ''}</div>`;
                });
                
                if (shouldCollapse && failedCount > maxCollapsed) {
                    html += `<div class="more-indicator">... dan ${remainingCount} lainnya</div>`;
                    html += `<div class="hidden-users" style="display: none;">`;
                    failedList.slice(maxCollapsed).forEach(user => {
                        html += `<div class="user-item">@${user.username} (${user.telegram_id})${user.error ? ` - ${user.error}` : ''}</div>`;
                    });
                    html += `</div>`;
                }
                
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            const toastType = failedCount === 0 ? 'success' : (successCount === 0 ? 'error' : 'warning');
            AdminPanel.showToast(html, toastType, 15000);
        }
        
        function toggleBroadcastList(button) {
            const isExpanded = button.dataset.expanded === 'true';
            const section = button.closest('.broadcast-section');
            const userList = section.querySelector('.user-list');
            const hiddenUsers = section.querySelector('.hidden-users');
            const moreIndicator = section.querySelector('.more-indicator');
            const toggleIcon = button.querySelector('.toggle-icon');
            
            if (isExpanded) {
                if (hiddenUsers) hiddenUsers.style.display = 'none';
                if (moreIndicator) moreIndicator.style.display = 'block';
                toggleIcon.textContent = '▼';
                button.dataset.expanded = 'false';
            } else {
                if (hiddenUsers) hiddenUsers.style.display = 'block';
                if (moreIndicator) moreIndicator.style.display = 'none';
                toggleIcon.textContent = '▲';
                button.dataset.expanded = 'true';
            }
        }

        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value;
            const target = document.getElementById('broadcastTarget').value;
            const broadcastType = document.getElementById('broadcastType').value;

            if (!message.trim()) {
                AdminPanel.showToast('Pesan tidak boleh kosong', 'error');
                return;
            }

            const typeLabel = broadcastType === 'v1' ? 'Telegram' : 'Mini App';
            const audienceLabel = target === 'all' ? 'semua user' : 'VIP users';

            showConfirmModal({
                title: 'Konfirmasi Broadcast',
                message: 'Apakah Anda yakin ingin mengirim broadcast <strong>' + typeLabel + '</strong> ke <strong>' + audienceLabel + '</strong>?',
                confirmText: 'Ya, Kirim',
                cancelText: 'Batal',
                type: 'warning',
                onConfirm: async () => {
                    try {
                        const response = await AdminPanel.apiCall('/admin/broadcast', {
                            method: 'POST',
                            body: JSON.stringify({
                                message,
                                target,
                                vip_only: target === 'vip',
                                broadcast_type: broadcastType
                            })
                        });

                        showBroadcastResult(response);
                        document.getElementById('broadcastMessage').value = '';
                        // Reload broadcast history setelah kirim broadcast baru
                        setTimeout(() => loadBroadcastHistory(), 1000);
                    } catch (error) {
                        console.error('Error sending broadcast:', error);
                        AdminPanel.showToast('Gagal mengirim broadcast', 'error');
                        throw error;
                    }
                }
            });
        }

        let broadcastHistory = [];

        async function loadBroadcastHistory() {
            try {
                const response = await AdminPanel.apiCall('/admin/broadcasts?page=1&limit=50');
                broadcastHistory = response.broadcasts || [];
                displayBroadcastHistory();
            } catch (error) {
                console.error('Error loading broadcast history:', error);
                document.getElementById('broadcastHistoryList').innerHTML = '<div class="empty-state">Gagal memuat broadcast history</div>';
            }
        }

        function displayBroadcastHistory() {
            const container = document.getElementById('broadcastHistoryList');
            
            if (!broadcastHistory || broadcastHistory.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada broadcast history.</div>';
                return;
            }

            container.innerHTML = `
                <div class="broadcast-list">
                    ${broadcastHistory.map(broadcast => `
                        <div class="broadcast-item ${!broadcast.is_active ? 'inactive' : ''}">
                            <div class="broadcast-content">
                                <div class="broadcast-message">${escapeHtml(broadcast.message)}</div>
                                <div class="broadcast-meta">
                                    <span class="meta-item">
                                        <strong>Target:</strong> ${broadcast.target === 'all' ? 'Semua User' : 'VIP Only'}
                                    </span>
                                    <span class="meta-item">
                                        <strong>Oleh:</strong> ${broadcast.created_by || 'Admin'}
                                    </span>
                                    <span class="meta-item">
                                        <strong>Dibuat:</strong> ${formatDate(broadcast.created_at)}
                                    </span>
                                    <span class="meta-item ${broadcast.is_active ? 'status-active' : 'status-inactive'}">
                                        ${broadcast.is_active ? '✓ Aktif' : '✗ Disembunyikan'}
                                    </span>
                                </div>
                            </div>
                            <div class="broadcast-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editBroadcastMessage(${broadcast.id})" title="Edit">
                                    <span data-icon="edit" data-icon-size="sm"></span>
                                </button>
                                <button class="btn btn-sm ${broadcast.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleBroadcastActive(${broadcast.id}, ${!broadcast.is_active})" title="${broadcast.is_active ? 'Sembunyikan' : 'Tampilkan'}">
                                    <span data-icon="${broadcast.is_active ? 'eyeOff' : 'eye'}" data-icon-size="sm"></span>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteBroadcast(${broadcast.id})" title="Hapus">
                                    <span data-icon="trash" data-icon-size="sm"></span>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            if (window.initIcons) {
                initIcons();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function editBroadcastMessage(broadcastId) {
            const broadcast = broadcastHistory.find(b => b.id === broadcastId);
            if (!broadcast) return;

            const newMessage = prompt('Edit Pesan Broadcast:', broadcast.message);
            if (!newMessage || newMessage === broadcast.message) return;

            try {
                await AdminPanel.apiCall(`/admin/broadcasts/${broadcastId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ message: newMessage })
                });

                AdminPanel.showToast('Broadcast berhasil diupdate', 'success');
                loadBroadcastHistory();
            } catch (error) {
                console.error('Error editing broadcast:', error);
                AdminPanel.showToast('Gagal update broadcast', 'error');
            }
        }

        async function toggleBroadcastActive(broadcastId, newActiveStatus) {
            try {
                await AdminPanel.apiCall(`/admin/broadcasts/${broadcastId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: newActiveStatus })
                });

                AdminPanel.showToast(
                    newActiveStatus ? 'Broadcast ditampilkan' : 'Broadcast disembunyikan',
                    'success'
                );
                loadBroadcastHistory();
            } catch (error) {
                console.error('Error toggling broadcast:', error);
                AdminPanel.showToast('Gagal update status broadcast', 'error');
            }
        }

        async function deleteBroadcast(broadcastId) {
            showConfirmModal({
                title: 'Hapus Broadcast',
                message: 'Apakah Anda yakin ingin menghapus broadcast ini?',
                confirmText: 'Ya, Hapus',
                cancelText: 'Batal',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        await AdminPanel.apiCall(`/admin/broadcasts/${broadcastId}`, {
                            method: 'DELETE'
                        });

                        AdminPanel.showToast('Broadcast berhasil dihapus', 'success');
                        loadBroadcastHistory();
                    } catch (error) {
                        console.error('Error deleting broadcast:', error);
                        AdminPanel.showToast('Gagal menghapus broadcast', 'error');
                        throw error;
                    }
                }
            });
        }

        async function exportData(type) {
            try {
                const token = localStorage.getItem('admin_token');
                const url = `${AdminPanel.API_BASE_URL}/admin/export/${type}`;
                
                const link = document.createElement('a');
                link.href = url + '?token=' + token;
                link.download = `${type}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                AdminPanel.showToast(`Export ${type} berhasil`, 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                AdminPanel.showToast('Gagal export data', 'error');
            }
        }

        function toggleTheme() {
            AdminPanel.toggleTheme();
        }

        async function loadAdminInfo() {
            try {
                const admin = await AdminPanel.apiCall('/admin/me');
                document.getElementById('adminUsername').textContent = admin.username;
            } catch (error) {
                console.error('Error loading admin info:', error);
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('settingModal');
            if (event.target === modal) {
                closeSettingModal();
            }
        }
    </script>

    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="dashboard.html" class="bottom-nav-item">
                <span class="nav-icon" data-icon="dashboard" data-icon-size="md"></span>
            </a>
            <a href="users.html" class="bottom-nav-item">
                <span class="nav-icon" data-icon="users" data-icon-size="md"></span>
            </a>
            <a href="movies.html" class="bottom-nav-item">
                <span class="nav-icon" data-icon="movie" data-icon-size="md"></span>
            </a>
            <a href="requests.html" class="bottom-nav-item">
                <span class="nav-icon" data-icon="fileText" data-icon-size="md"></span>
            </a>
            <a href="withdrawals.html" class="bottom-nav-item">
                <span class="nav-icon" data-icon="dollarSign" data-icon-size="md"></span>
            </a>
            <a href="payments.html" class="bottom-nav-item">
                <span class="nav-icon" data-icon="creditCard" data-icon-size="md"></span>
            </a>
        </div>
    </nav>
    <script>
        // Start auto-refresh untuk update real-time
        AdminPanel.startAutoRefresh(10000);

        window.addEventListener('DOMContentLoaded', function() {
            if (window.initIcons) {
                initIcons();
            }
            AdminPanel.checkAuth();
            AdminPanel.init();
            AdminPanel.initMobileSidebarAdminUsers();
            AdminPanel.initSidebarUserInfo();
            loadAdminInfo();
            loadSettings();
            loadBroadcastHistory();
        });
    </script>

    <style>
        .broadcast-section, .export-section {
            margin-bottom: 24px;
        }

        .broadcast-section h3, .export-section h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .setting-info {
            flex: 1;
        }

        .setting-key {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .setting-value {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .broadcast-result {
            font-size: 14px;
            line-height: 1.5;
        }

        .broadcast-summary {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .broadcast-section {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
        }

        .success-section {
            border-left: 3px solid #22c55e;
        }

        .failed-section {
            border-left: 3px solid #ef4444;
        }

        .broadcast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .section-title {
            font-weight: 600;
            font-size: 13px;
        }

        .success-section .section-title {
            color: #22c55e;
        }

        .failed-section .section-title {
            color: #ef4444;
        }

        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            color: var(--text-primary);
            font-size: 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .toggle-icon {
            display: inline-block;
            transition: transform 0.2s;
        }

        .user-list {
            font-size: 12px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .user-list.collapsed {
            max-height: none;
        }

        .user-item {
            padding: 2px 0;
            color: var(--text-secondary);
        }

        .more-indicator {
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.7;
            padding: 4px 0;
        }

        .hidden-users {
            transition: opacity 0.3s ease;
        }

        /* Broadcast History Styles */
        .broadcast-history-section h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .broadcast-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .broadcast-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
            gap: 16px;
        }

        .broadcast-item.inactive {
            opacity: 0.6;
            border-left: 3px solid #ef4444;
        }

        .broadcast-content {
            flex: 1;
        }

        .broadcast-message {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .broadcast-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .meta-item {
            display: inline-block;
        }

        .meta-item strong {
            color: var(--text-primary);
        }

        .status-active {
            color: #22c55e;
        }

        .status-inactive {
            color: #ef4444;
        }

        .broadcast-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .broadcast-item {
                flex-direction: column;
            }

            .broadcast-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .broadcast-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</html>

<!-- MOBILE SIDEBAR -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<aside class="sidebar-mobile" id="sidebarMobile">
    <div class="sidebar-header">
        <div class="logo">
            <img src="assets/logo-dramamu.jpg" alt="Dramamu Logo">
        </div>
        <h2>Dramamu Admin</h2>
        <p class="admin-subtitle">Panel Kontrol</p>
        <button class="sidebar-close" id="sidebarMobileClose" aria-label="Close Menu">
            <span data-icon="x" data-icon-size="md"></span>
        </button>
    </div>
    <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item" data-page="dashboard"><span class="nav-icon" data-icon="dashboard" data-icon-size="md"></span><span>Dashboard</span></a>
        <a href="analytics.html" class="nav-item" data-page="analytics"><span class="nav-icon" data-icon="barChart" data-icon-size="md"></span><span>Analytics</span></a>
        <a href="users.html" class="nav-item" data-page="users"><span class="nav-icon" data-icon="users" data-icon-size="md"></span><span>Pengguna</span></a>
        <a href="movies.html" class="nav-item" data-page="movies"><span class="nav-icon" data-icon="movie" data-icon-size="md"></span><span>Drama</span></a>
        <a href="requests.html" class="nav-item" data-page="requests"><span class="nav-icon" data-icon="fileText" data-icon-size="md"></span><span>Permintaan</span></a>
        <a href="withdrawals.html" class="nav-item" data-page="withdrawals"><span class="nav-icon" data-icon="dollarSign" data-icon-size="md"></span><span>Penarikan</span></a>
        <a href="payments.html" class="nav-item" data-page="payments"><span class="nav-icon" data-icon="creditCard" data-icon-size="md"></span><span>Pembayaran</span></a>
        <a href="settings.html" class="nav-item" data-page="settings"><span class="nav-icon" data-icon="settings" data-icon-size="md"></span><span>Pengaturan</span></a>
        <a href="admin-users.html" class="nav-item" data-page="admin-users" style="display: none;"><span class="nav-icon" data-icon="shield" data-icon-size="md"></span><span>Admin Users</span></a>
    </nav>
    <div id="sidebarMobileAdminUsers" class="sidebar-mobile-content"><div class="loading-message">Memuat...</div></div>
</aside>
</body>
